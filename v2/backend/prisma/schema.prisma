datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  SUPERADMIN
  ADMIN
  COORDINATOR
  MANAGER
  COLLABORATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum EntityStatus {
  ACTIVE
  INACTIVE
}

model Company {
  id        String       @id @default(uuid()) @db.Uuid
  name      String
  cnpj      String?      @unique
  logoUrl   String?
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  units         Unit[]
  sectors       Sector[]
  users         User[]
  categories    Category[]
  links         Link[]
  schedules     UploadedSchedule[]
  notifications Notification[]
}

model Unit {
  id        String       @id @default(uuid()) @db.Uuid
  companyId String       @db.Uuid
  name      String
  cnpj      String?      @unique
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  company Company @relation(fields: [companyId], references: [id])
  sectors Sector[]
  users   User[]
}

model Sector {
  id          String       @id @default(uuid()) @db.Uuid
  companyId   String       @db.Uuid
  unitId      String       @db.Uuid
  name        String
  description String?
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company   Company            @relation(fields: [companyId], references: [id])
  unit      Unit               @relation(fields: [unitId], references: [id])
  users     User[]
  links     Link[]
  schedules UploadedSchedule[]
}

model User {
  id           String      @id @default(uuid()) @db.Uuid
  companyId    String?     @db.Uuid
  unitId       String?     @db.Uuid
  sectorId     String?     @db.Uuid
  name         String
  email        String      @unique
  cpf          String?     @unique
  passwordHash String
  role         UserRole    @default(COLLABORATOR)
  status       UserStatus  @default(ACTIVE)
  avatarUrl    String?
  theme        Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  company         Company?        @relation(fields: [companyId], references: [id])
  unit            Unit?           @relation(fields: [unitId], references: [id])
  sector          Sector?         @relation(fields: [sectorId], references: [id])
  refreshTokens   RefreshToken[]
  linksCreated    Link[]          @relation("LinkCreator")
  schedulesCreated UploadedSchedule[] @relation("ScheduleCreator")
  favorites       Favorite[]
  linkVersions    LinkVersion[]   @relation("LinkVersionChanger")
  notifications   Notification[]  @relation("NotificationRecipient")
  activityLogs    ActivityLog[]   @relation("ActivityLogger")
  auditLogs       AuditLog[]      @relation("AuditLogger")
}

model RolePermission {
  id                   String   @id @default(uuid()) @db.Uuid
  role                 UserRole @unique
  canViewDashboard      Boolean  @default(false)
  canAccessAdmin        Boolean  @default(false)
  canViewUsers          Boolean  @default(false)
  canCreateUsers        Boolean  @default(false)
  canEditUsers          Boolean  @default(false)
  canDeleteUsers        Boolean  @default(false)
  canViewSectors        Boolean  @default(false)
  canManageSectors      Boolean  @default(false)
  canViewLinks          Boolean  @default(true)
  canManageLinks        Boolean  @default(false)
  canManageCategories   Boolean  @default(false)
  canManageSchedules    Boolean  @default(false)
  canBackupSystem       Boolean  @default(false)
  canResetSystem        Boolean  @default(false)
  canViewAuditLogs      Boolean  @default(false)
  canManageSystemConfig Boolean  @default(false)
  restrictToOwnSector   Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// ===== PORTAL FACILITA =====

model Category {
  id        String       @id @default(uuid()) @db.Uuid
  companyId String       @db.Uuid
  name      String
  color     String?
  icon      String?
  adminOnly Boolean      @default(false)
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  company   Company            @relation(fields: [companyId], references: [id])
  links     Link[]
  schedules UploadedSchedule[]

  @@index([companyId])
}

model Link {
  id          String       @id @default(uuid()) @db.Uuid
  companyId   String       @db.Uuid
  userId      String?      @db.Uuid
  sectorId    String?      @db.Uuid
  categoryId  String?      @db.Uuid
  title       String
  url         String
  description String?
  color       String?
  imageUrl    String?
  isPublic    Boolean      @default(true)
  order       Int          @default(0)
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?

  company   Company   @relation(fields: [companyId], references: [id])
  user      User?     @relation("LinkCreator", fields: [userId], references: [id])
  sector    Sector?   @relation(fields: [sectorId], references: [id])
  category  Category? @relation(fields: [categoryId], references: [id])
  favorites Favorite[]
  tags      TagOnLink[]
  versions  LinkVersion[]

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([categoryId])
}

model UploadedSchedule {
  id         String       @id @default(uuid()) @db.Uuid
  companyId  String       @db.Uuid
  userId     String?      @db.Uuid
  sectorId   String?      @db.Uuid
  categoryId String?      @db.Uuid
  title      String
  fileUrl    String
  fileName   String
  fileSize   Int
  isPublic   Boolean      @default(true)
  status     EntityStatus @default(ACTIVE)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  deletedAt  DateTime?

  company   Company   @relation(fields: [companyId], references: [id])
  user      User?     @relation("ScheduleCreator", fields: [userId], references: [id])
  sector    Sector?   @relation(fields: [sectorId], references: [id])
  category  Category? @relation(fields: [categoryId], references: [id])
  favorites Favorite[]
  tags      TagOnSchedule[]

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([categoryId])
}

// ===== FUNCIONALIDADES EXTRAS =====

enum EntityType {
  LINK
  SCHEDULE
  USER
  SECTOR
  COMPANY
}

model Favorite {
  id         String      @id @default(uuid()) @db.Uuid
  userId     String      @db.Uuid
  entityType EntityType
  linkId     String?     @db.Uuid
  scheduleId String?     @db.Uuid
  createdAt  DateTime    @default(now())

  user     User              @relation(fields: [userId], references: [id])
  link     Link?             @relation(fields: [linkId], references: [id])
  schedule UploadedSchedule? @relation(fields: [scheduleId], references: [id])

  @@unique([userId, entityType, linkId, scheduleId])
  @@index([userId])
}

model Tag {
  id        String   @id @default(uuid()) @db.Uuid
  name      String   @unique
  color     String?
  createdAt DateTime @default(now())

  links     TagOnLink[]
  schedules TagOnSchedule[]
}

model TagOnLink {
  linkId String @db.Uuid
  tagId  String @db.Uuid

  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)
  tag  Tag  @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([linkId, tagId])
}

model TagOnSchedule {
  scheduleId String @db.Uuid
  tagId      String @db.Uuid

  schedule UploadedSchedule @relation(fields: [scheduleId], references: [id], onDelete: Cascade)
  tag      Tag              @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([scheduleId, tagId])
}

model LinkVersion {
  id           String   @id @default(uuid()) @db.Uuid
  linkId       String   @db.Uuid
  title        String
  url          String
  description  String?
  changedBy    String   @db.Uuid
  changeReason String?
  createdAt    DateTime @default(now())

  link        Link @relation(fields: [linkId], references: [id], onDelete: Cascade)
  changedByUser User @relation("LinkVersionChanger", fields: [changedBy], references: [id])

  @@index([linkId])
}

enum NotificationType {
  EMAIL
  IN_APP
}

enum NotificationStatus {
  PENDING
  SENT
  FAILED
  READ
}

model Notification {
  id        String             @id @default(uuid()) @db.Uuid
  companyId String             @db.Uuid
  userId    String?            @db.Uuid
  type      NotificationType
  status    NotificationStatus @default(PENDING)
  title     String
  message   String
  data      Json?
  readAt    DateTime?
  sentAt    DateTime?
  createdAt DateTime           @default(now())

  company Company @relation(fields: [companyId], references: [id])
  user    User?   @relation("NotificationRecipient", fields: [userId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([status])
}

model ActivityLog {
  id         String     @id @default(uuid()) @db.Uuid
  userId     String?    @db.Uuid
  action     String
  entityType EntityType
  entityId   String     @db.Uuid
  metadata   Json?
  ip         String?
  createdAt  DateTime   @default(now())

  user User? @relation("ActivityLogger", fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ===== SISTEMA =====

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @db.Uuid
  action     String
  targetType String?
  targetId   String?  @db.Uuid
  details    Json?
  ip         String?
  createdAt  DateTime @default(now())

  user User? @relation("AuditLogger", fields: [userId], references: [id])

  @@index([userId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model SystemConfig {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique
  value       String
  description String?
  type        String   @default("string")
  isEditable  Boolean  @default(true)
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
