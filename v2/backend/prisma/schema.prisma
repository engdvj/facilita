datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  SUPERADMIN
  ADMIN
  COLLABORATOR
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum EntityStatus {
  ACTIVE
  INACTIVE
}

enum ContentAudience {
  PUBLIC
  COMPANY
  SECTOR
  PRIVATE
  ADMIN
  SUPERADMIN
}

model Company {
  id        String       @id @default(uuid()) @db.Uuid
  name      String
  cnpj      String?      @unique
  logoUrl   String?
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  units         Unit[]
  sectors       Sector[]
  users         User[]
  categories    Category[]
  links         Link[]
  schedules     UploadedSchedule[]
  notes         Note[]
}

model Unit {
  id        String       @id @default(uuid()) @db.Uuid
  companyId String       @db.Uuid
  name      String
  cnpj      String?      @unique
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  company Company @relation(fields: [companyId], references: [id])
  sectors Sector[]
  users   User[]
}

model Sector {
  id          String       @id @default(uuid()) @db.Uuid
  companyId   String       @db.Uuid
  unitId      String       @db.Uuid
  name        String
  description String?
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company   Company            @relation(fields: [companyId], references: [id])
  unit      Unit               @relation(fields: [unitId], references: [id])
  users     User[]
  links     Link[]
  schedules UploadedSchedule[]
  notes     Note[]
}

model User {
  id           String      @id @default(uuid()) @db.Uuid
  companyId    String?     @db.Uuid
  unitId       String?     @db.Uuid
  sectorId     String?     @db.Uuid
  name         String
  email        String      @unique
  cpf          String?     @unique
  passwordHash String
  role         UserRole    @default(COLLABORATOR)
  status       UserStatus  @default(ACTIVE)
  avatarUrl    String?
  theme        Json?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  company         Company?        @relation(fields: [companyId], references: [id])
  unit            Unit?           @relation(fields: [unitId], references: [id])
  sector          Sector?         @relation(fields: [sectorId], references: [id])
  refreshTokens   RefreshToken[]
  linksCreated    Link[]          @relation("LinkCreator")
  schedulesCreated UploadedSchedule[] @relation("ScheduleCreator")
  notesCreated    Note[]          @relation("NoteCreator")
  favorites       Favorite[]
  linkVersions    LinkVersion[]   @relation("LinkVersionChanger")
  activityLogs    ActivityLog[]   @relation("ActivityLogger")
  auditLogs       AuditLog[]      @relation("AuditLogger")
}

model RolePermission {
  id                   String   @id @default(uuid()) @db.Uuid
  role                 UserRole @unique
  canViewDashboard      Boolean  @default(false)
  canAccessAdmin        Boolean  @default(false)
  canViewUsers          Boolean  @default(false)
  canCreateUsers        Boolean  @default(false)
  canEditUsers          Boolean  @default(false)
  canDeleteUsers        Boolean  @default(false)
  canViewSectors        Boolean  @default(false)
  canManageSectors      Boolean  @default(false)
  canViewLinks          Boolean  @default(true)
  canManageLinks        Boolean  @default(false)
  canManageCategories   Boolean  @default(false)
  canManageSchedules    Boolean  @default(false)
  canBackupSystem       Boolean  @default(false)
  canResetSystem        Boolean  @default(false)
  canViewAuditLogs      Boolean  @default(false)
  canManageSystemConfig Boolean  @default(false)
  restrictToOwnSector   Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// ===== PORTAL FACILITA =====

model Category {
  id        String       @id @default(uuid()) @db.Uuid
  companyId String       @db.Uuid
  name      String
  color     String?
  icon      String?
  adminOnly Boolean      @default(false)
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  company   Company            @relation(fields: [companyId], references: [id])
  links     Link[]
  schedules UploadedSchedule[]
  notes     Note[]

  @@index([companyId])
}

model Link {
  id            String       @id @default(uuid()) @db.Uuid
  companyId     String       @db.Uuid
  userId        String?      @db.Uuid
  sectorId      String?      @db.Uuid
  categoryId    String?      @db.Uuid
  title         String
  url           String
  description   String?
  color         String?
  imageUrl      String?
  imagePosition String?
  imageScale    Float?
  audience      ContentAudience @default(COMPANY)
  isPublic      Boolean      @default(true)
  order         Int          @default(0)
  status        EntityStatus @default(ACTIVE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  company   Company   @relation(fields: [companyId], references: [id])
  user      User?     @relation("LinkCreator", fields: [userId], references: [id])
  sector    Sector?   @relation(fields: [sectorId], references: [id])
  category  Category? @relation(fields: [categoryId], references: [id])
  favorites Favorite[]
  versions  LinkVersion[]

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([categoryId])
}

model UploadedSchedule {
  id         String       @id @default(uuid()) @db.Uuid
  companyId  String       @db.Uuid
  userId     String?      @db.Uuid
  sectorId   String?      @db.Uuid
  categoryId String?      @db.Uuid
  title      String
  fileUrl    String
  fileName   String
  fileSize   Int
  color      String?
  imageUrl   String?
  imagePosition String?
  imageScale Float?
  audience   ContentAudience @default(COMPANY)
  isPublic   Boolean      @default(true)
  status     EntityStatus @default(ACTIVE)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  deletedAt  DateTime?

  company   Company   @relation(fields: [companyId], references: [id])
  user      User?     @relation("ScheduleCreator", fields: [userId], references: [id])
  sector    Sector?   @relation(fields: [sectorId], references: [id])
  category  Category? @relation(fields: [categoryId], references: [id])
  favorites Favorite[]

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([categoryId])
}

model Note {
  id            String          @id @default(uuid()) @db.Uuid
  companyId     String          @db.Uuid
  userId        String?         @db.Uuid
  sectorId      String?         @db.Uuid
  categoryId    String?         @db.Uuid
  title         String
  content       String
  color         String?
  imageUrl      String?
  imagePosition String?
  imageScale    Float?
  audience      ContentAudience @default(COMPANY)
  isPublic      Boolean         @default(true)
  status        EntityStatus    @default(ACTIVE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?

  company  Company   @relation(fields: [companyId], references: [id])
  user     User?     @relation("NoteCreator", fields: [userId], references: [id])
  sector   Sector?   @relation(fields: [sectorId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([categoryId])
}

// ===== FUNCIONALIDADES EXTRAS =====
// Nota: Models de Tags e Notificações foram removidos intencionalmente
// Foco nas 8 funcionalidades priorizadas: Favoritos, Busca, Histórico de Versões,
// Upload Avançado, Auditoria, ActivityLog, SystemConfig e PWA

enum EntityType {
  LINK
  SCHEDULE
  NOTE
  USER
  SECTOR
  COMPANY
}

model Favorite {
  id         String      @id @default(uuid()) @db.Uuid
  userId     String      @db.Uuid
  entityType EntityType
  linkId     String?     @db.Uuid
  scheduleId String?     @db.Uuid
  createdAt  DateTime    @default(now())

  user     User              @relation(fields: [userId], references: [id])
  link     Link?             @relation(fields: [linkId], references: [id])
  schedule UploadedSchedule? @relation(fields: [scheduleId], references: [id])

  @@unique([userId, entityType, linkId, scheduleId])
  @@index([userId])
}

model LinkVersion {
  id           String   @id @default(uuid()) @db.Uuid
  linkId       String   @db.Uuid
  title        String
  url          String
  description  String?
  changedBy    String   @db.Uuid
  changeReason String?
  createdAt    DateTime @default(now())

  link        Link @relation(fields: [linkId], references: [id], onDelete: Cascade)
  changedByUser User @relation("LinkVersionChanger", fields: [changedBy], references: [id])

  @@index([linkId])
}

model ActivityLog {
  id         String     @id @default(uuid()) @db.Uuid
  userId     String?    @db.Uuid
  action     String
  entityType EntityType
  entityId   String     @db.Uuid
  metadata   Json?
  ip         String?
  createdAt  DateTime   @default(now())

  user User? @relation("ActivityLogger", fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ===== SISTEMA =====

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @db.Uuid
  action     String
  targetType String?
  targetId   String?  @db.Uuid
  details    Json?
  ip         String?
  createdAt  DateTime @default(now())

  user User? @relation("AuditLogger", fields: [userId], references: [id])

  @@index([userId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model SystemConfig {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique
  value       String
  description String?
  type        String   @default("string")
  isEditable  Boolean  @default(true)
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
