datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
}

enum UserRole {
  SUPERADMIN
  ADMIN
  COLLABORATOR
}

enum SectorRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
}

enum EntityStatus {
  ACTIVE
  INACTIVE
}

enum ContentAudience {
  PUBLIC
  COMPANY
  SECTOR
  PRIVATE
  ADMIN
  SUPERADMIN
}

model Company {
  id        String       @id @default(uuid()) @db.Uuid
  name      String
  cnpj      String?      @unique
  logoUrl   String?
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  units         Unit[]
  sectors       Sector[]
  users         User[]
  categories    Category[]
  links         Link[]
  schedules     UploadedSchedule[]
  notes         Note[]
  uploadedImages UploadedImage[]
}

model Unit {
  id        String       @id @default(uuid()) @db.Uuid
  companyId String       @db.Uuid
  name      String
  cnpj      String?      @unique
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  company     Company      @relation(fields: [companyId], references: [id])
  sectorUnits SectorUnit[]
  linkUnits   LinkUnit[]
}

model Sector {
  id          String       @id @default(uuid()) @db.Uuid
  companyId   String       @db.Uuid
  name        String
  description String?
  status      EntityStatus @default(ACTIVE)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  company     Company            @relation(fields: [companyId], references: [id])
  links       Link[]
  schedules   UploadedSchedule[]
  notes       Note[]
  sectorUnits SectorUnit[]
  userSectors UserSector[]
}

model User {
  id           String     @id @default(uuid()) @db.Uuid
  companyId    String?    @db.Uuid
  name         String
  email        String     @unique
  cpf          String?    @unique
  passwordHash String
  role         UserRole   @default(COLLABORATOR)
  status       UserStatus @default(ACTIVE)
  avatarUrl    String?
  theme        Json?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  company          Company?           @relation(fields: [companyId], references: [id])
  refreshTokens    RefreshToken[]
  linksCreated     Link[]             @relation("LinkCreator")
  schedulesCreated UploadedSchedule[] @relation("ScheduleCreator")
  notesCreated     Note[]             @relation("NoteCreator")
  favorites        Favorite[]
  linkVersions     LinkVersion[]      @relation("LinkVersionChanger")
  activityLogs     ActivityLog[]      @relation("ActivityLogger")
  auditLogs        AuditLog[]         @relation("AuditLogger")
  uploadedImages   UploadedImage[]    @relation("ImageUploader")
  notifications    Notification[]     @relation("UserNotifications")
  userSectors      UserSector[]
}

model RolePermission {
  id                   String   @id @default(uuid()) @db.Uuid
  role                 UserRole @unique
  canViewDashboard      Boolean  @default(false)
  canAccessAdmin        Boolean  @default(false)
  canViewUsers          Boolean  @default(false)
  canCreateUsers        Boolean  @default(false)
  canEditUsers          Boolean  @default(false)
  canDeleteUsers        Boolean  @default(false)
  canViewSectors        Boolean  @default(false)
  canManageSectors      Boolean  @default(false)
  canViewLinks          Boolean  @default(true)
  canManageLinks        Boolean  @default(false)
  canManageCategories   Boolean  @default(false)
  canManageSchedules    Boolean  @default(false)
  canBackupSystem       Boolean  @default(false)
  canResetSystem        Boolean  @default(false)
  canViewAuditLogs      Boolean  @default(false)
  canManageSystemConfig Boolean  @default(false)
  restrictToOwnSector   Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  tokenHash String
  expiresAt DateTime
  revokedAt DateTime?
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
}

// ===== PORTAL FACILITA =====

model Category {
  id        String       @id @default(uuid()) @db.Uuid
  companyId String       @db.Uuid
  name      String
  color     String?
  icon      String?
  adminOnly Boolean      @default(false)
  status    EntityStatus @default(ACTIVE)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  company   Company            @relation(fields: [companyId], references: [id])
  links     Link[]
  schedules UploadedSchedule[]
  notes     Note[]

  @@index([companyId])
}

model Link {
  id            String       @id @default(uuid()) @db.Uuid
  companyId     String       @db.Uuid
  userId        String?      @db.Uuid
  sectorId      String?      @db.Uuid
  unitId        String?      @db.Uuid
  categoryId    String?      @db.Uuid
  title         String
  url           String
  description   String?
  color         String?
  imageUrl      String?
  imagePosition String?
  imageScale    Float?
  audience      ContentAudience @default(COMPANY)
  isPublic      Boolean      @default(true)
  order         Int          @default(0)
  status        EntityStatus @default(ACTIVE)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  deletedAt     DateTime?

  company   Company   @relation(fields: [companyId], references: [id])
  user      User?     @relation("LinkCreator", fields: [userId], references: [id])
  sector    Sector?   @relation(fields: [sectorId], references: [id])
  unit      Unit?     @relation(fields: [unitId], references: [id])
  category  Category? @relation(fields: [categoryId], references: [id])
  favorites Favorite[]
  versions  LinkVersion[]
  linkUnits LinkUnit[]

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([unitId])
  @@index([categoryId])
}

model LinkUnit {
  id        String   @id @default(uuid()) @db.Uuid
  linkId    String   @db.Uuid
  unitId    String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  link Link @relation(fields: [linkId], references: [id], onDelete: Cascade)
  unit Unit @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([linkId, unitId])
  @@index([linkId])
  @@index([unitId])
}

model UploadedSchedule {
  id         String       @id @default(uuid()) @db.Uuid
  companyId  String       @db.Uuid
  userId     String?      @db.Uuid
  sectorId   String?      @db.Uuid
  unitId     String?      @db.Uuid
  categoryId String?      @db.Uuid
  title      String
  fileUrl    String
  fileName   String
  fileSize   Int
  color      String?
  imageUrl   String?
  imagePosition String?
  imageScale Float?
  audience   ContentAudience @default(COMPANY)
  isPublic   Boolean      @default(true)
  status     EntityStatus @default(ACTIVE)
  createdAt  DateTime     @default(now())
  updatedAt  DateTime     @updatedAt
  deletedAt  DateTime?

  company   Company   @relation(fields: [companyId], references: [id])
  user      User?     @relation("ScheduleCreator", fields: [userId], references: [id])
  sector    Sector?   @relation(fields: [sectorId], references: [id])
  unit      Unit?     @relation(fields: [unitId], references: [id])
  category  Category? @relation(fields: [categoryId], references: [id])
  favorites Favorite[]

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([unitId])
  @@index([categoryId])
}

model Note {
  id            String          @id @default(uuid()) @db.Uuid
  companyId     String          @db.Uuid
  userId        String?         @db.Uuid
  sectorId      String?         @db.Uuid
  unitId        String?         @db.Uuid
  categoryId    String?         @db.Uuid
  title         String
  content       String
  color         String?
  imageUrl      String?
  imagePosition String?
  imageScale    Float?
  audience      ContentAudience @default(COMPANY)
  isPublic      Boolean         @default(true)
  status        EntityStatus    @default(ACTIVE)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  deletedAt     DateTime?

  company  Company   @relation(fields: [companyId], references: [id])
  user     User?     @relation("NoteCreator", fields: [userId], references: [id])
  sector   Sector?   @relation(fields: [sectorId], references: [id])
  unit     Unit?     @relation(fields: [unitId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id])
  favorites Favorite[]

  @@index([companyId])
  @@index([userId])
  @@index([sectorId])
  @@index([unitId])
  @@index([categoryId])
}

model UploadedImage {
  id           String       @id @default(uuid()) @db.Uuid
  companyId    String       @db.Uuid
  uploadedBy   String       @db.Uuid

  filename     String
  originalName String
  url          String
  mimeType     String
  size         Int
  width        Int?
  height       Int?

  alt          String?
  tags         String[]     @default([])

  status       EntityStatus @default(ACTIVE)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  deletedAt    DateTime?

  company      Company      @relation(fields: [companyId], references: [id])
  user         User         @relation("ImageUploader", fields: [uploadedBy], references: [id])

  @@index([companyId])
  @@index([uploadedBy])
  @@index([createdAt])
}

// ===== FUNCIONALIDADES EXTRAS =====
// Nota: Models de Tags e Notificações foram removidos intencionalmente
// Foco nas 8 funcionalidades priorizadas: Favoritos, Busca, Histórico de Versões,
// Upload Avançado, Auditoria, ActivityLog, SystemConfig e PWA

enum EntityType {
  LINK
  SCHEDULE
  NOTE
  USER
  SECTOR
  COMPANY
}

enum NotificationType {
  CONTENT_DELETED
  CONTENT_CREATED
  CONTENT_UPDATED
  CONTENT_RESTORED
  CONTENT_ACTIVATED
  CONTENT_DEACTIVATED
  FAVORITE_UPDATED
  FAVORITE_DELETED
  CONTENT_FAVORITED
}

model Notification {
  id          String           @id @default(uuid()) @db.Uuid
  userId      String           @db.Uuid
  type        NotificationType
  entityType  EntityType
  entityId    String           @db.Uuid
  title       String
  message     String
  actionUrl   String?
  metadata    Json?
  read        Boolean          @default(false)
  createdAt   DateTime         @default(now())

  user        User             @relation("UserNotifications", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, read])
  @@index([userId, createdAt])
  @@index([createdAt])
}

model Favorite {
  id         String      @id @default(uuid()) @db.Uuid
  userId     String      @db.Uuid
  entityType EntityType
  linkId     String?     @db.Uuid
  scheduleId String?     @db.Uuid
  noteId     String?     @db.Uuid
  createdAt  DateTime    @default(now())

  user     User              @relation(fields: [userId], references: [id])
  link     Link?             @relation(fields: [linkId], references: [id])
  schedule UploadedSchedule? @relation(fields: [scheduleId], references: [id])
  note     Note?             @relation(fields: [noteId], references: [id])

  @@unique([userId, entityType, linkId, scheduleId, noteId])
  @@index([userId])
}

model LinkVersion {
  id           String   @id @default(uuid()) @db.Uuid
  linkId       String   @db.Uuid
  title        String
  url          String
  description  String?
  changedBy    String   @db.Uuid
  changeReason String?
  createdAt    DateTime @default(now())

  link        Link @relation(fields: [linkId], references: [id], onDelete: Cascade)
  changedByUser User @relation("LinkVersionChanger", fields: [changedBy], references: [id])

  @@index([linkId])
}

model ActivityLog {
  id         String     @id @default(uuid()) @db.Uuid
  userId     String?    @db.Uuid
  action     String
  entityType EntityType
  entityId   String     @db.Uuid
  metadata   Json?
  ip         String?
  createdAt  DateTime   @default(now())

  user User? @relation("ActivityLogger", fields: [userId], references: [id])

  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt])
}

// ===== SISTEMA =====

model AuditLog {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String?  @db.Uuid
  action     String
  targetType String?
  targetId   String?  @db.Uuid
  details    Json?
  ip         String?
  createdAt  DateTime @default(now())

  user User? @relation("AuditLogger", fields: [userId], references: [id])

  @@index([userId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model SystemConfig {
  id          String   @id @default(uuid()) @db.Uuid
  key         String   @unique
  value       String
  description String?
  type        String   @default("string")
  isEditable  Boolean  @default(true)
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ===== RELACIONAMENTOS MUITOS-PARA-MUITOS =====

// Um setor pode estar vinculado a múltiplas unidades
// Uma unidade pode ter múltiplos setores
model SectorUnit {
  id        String   @id @default(uuid()) @db.Uuid
  sectorId  String   @db.Uuid
  unitId    String   @db.Uuid
  isPrimary Boolean  @default(false) // Marca a unidade principal do setor
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  sector Sector @relation(fields: [sectorId], references: [id], onDelete: Cascade)
  unit   Unit   @relation(fields: [unitId], references: [id], onDelete: Cascade)

  @@unique([sectorId, unitId])
  @@index([sectorId])
  @@index([unitId])
}

// Um usuário pode pertencer a múltiplos setores
// Um setor pode ter múltiplos usuários
model UserSector {
  id         String     @id @default(uuid()) @db.Uuid
  userId     String     @db.Uuid
  sectorId   String     @db.Uuid
  isPrimary  Boolean    @default(false) // Marca o setor principal do usuário
  role       SectorRole @default(MEMBER) // Papel do usuário dentro deste setor específico
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  sector Sector @relation(fields: [sectorId], references: [id], onDelete: Cascade)

  @@unique([userId, sectorId])
  @@index([userId])
  @@index([sectorId])
}
